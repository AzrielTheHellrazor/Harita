<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, width=device-width" />
    <script src="https://js.api.here.com/v3/3.1/mapsjs-core.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-service.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-ui.js" type="text/javascript" charset="utf-8"></script>
    <link rel="stylesheet" type="text/css" href="https://js.api.here.com/v3/3.1/mapsjs-ui.css" />
    <style>
        #status {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body>
    <div id="status">Konum alınıyor...</div>
    <div id="map" style="width: 100%; height: 960px;"></div>
    <script type="text/javascript">

// Kullanıcı konumunu al ve etrafındaki kafeleri göster
function getUserLocationAndShowCafes(map, platform, apiKey) {
    const statusDiv = document.getElementById('status');
    
    if (!navigator.geolocation) {
        statusDiv.innerHTML = 'Geolocation desteklenmiyor!';
        return;
    }
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;
            const userLocation = {lat: userLat, lng: userLng};
            
            statusDiv.innerHTML = `Konum bulundu: ${userLat.toFixed(4)}, ${userLng.toFixed(4)}`;
            
            map.setCenter(userLocation);
            map.setZoom(15);
            
            addUserLocationMarker(map, userLocation);
            
            searchNearbyCafes(map, platform, userLocation, apiKey);
        },
        function(error) {
            let errorMsg = 'Konum alınamadı: ';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg += 'Konum izni reddedildi.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg += 'Konum bilgisi mevcut değil.';
                    break;
                case error.TIMEOUT:
                    errorMsg += 'Konum alma zaman aşımı.';
                    break;
                default:
                    errorMsg += 'Bilinmeyen hata.';
                    break;
            }
            statusDiv.innerHTML = errorMsg;
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 60000
        }
    );
}

// Kullanıcı konumunu haritaya işaretle
function addUserLocationMarker(map, userLocation) {
    const userIcon = new H.map.Icon(
        'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(`
        <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
            <circle cx="16" cy="16" r="12" fill="#4285F4" stroke="#ffffff" stroke-width="3"/>
            <circle cx="16" cy="16" r="6" fill="#ffffff"/>
        </svg>
        `), 
        {size: {w: 32, h: 32}}
    );
    
    const userMarker = new H.map.Marker(userLocation, {icon: userIcon});
    map.addObject(userMarker);
    
    userMarker.addEventListener('tap', function() {
        const bubble = new H.ui.InfoBubble({ lat: userLocation.lat, lng: userLocation.lng }, {
            content: '<b>Mevcut Konumunuz</b>'
        });
        ui.addBubble(bubble);
    });
}

// Yakındaki kafeleri ara
function searchNearbyCafes(map, platform, userLocation, apiKey) {
    const searchService = platform.getSearchService();
    const statusDiv = document.getElementById('status');
    
    statusDiv.innerHTML = 'Yakındaki kafeler aranıyor...';
    
    searchService.browse({
        at: `${userLocation.lat},${userLocation.lng}`,
        categories: '100-1000-0001', // Sadece kafe/pub kategorisi için arama yap
        limit: 20
    }, (result) => {
        if (result.items && result.items.length > 0) {
            statusDiv.innerHTML = `${result.items.length} kafe bulundu`;
            
            const group = new H.map.Group();
            
            result.items.forEach((cafe, index) => {
                addCafeMarker(map, cafe, index + 1, apiKey);
                group.addObject(new H.map.Marker({
                    lat: cafe.position.lat, 
                    lng: cafe.position.lng
                }));
            });
            
            group.addObject(new H.map.Marker(userLocation));
            
            map.getViewModel().setLookAtData({
                bounds: group.getBoundingBox(),
                padding: new H.math.Rect(50, 50, 50, 50)
            });
        } else {
            statusDiv.innerHTML = 'Yakınlarda kafe bulunamadı';
        }
    }, (error) => {
        statusDiv.innerHTML = 'Arama hatası: ' + error;
    });
}

// Kafe markırını ekle
function addCafeMarker(map, cafe, index, apiKey) {
    const cafeIcon = new H.map.Icon(
        'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(`
        <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
            <circle cx="16" cy="16" r="14" fill="#8B4513" stroke="#ffffff" stroke-width="2"/>
            <text x="16" y="20" text-anchor="middle" fill="white" font-family="Arial" font-size="12" font-weight="bold">${index}</text>
        </svg>
        `), 
        {size: {w: 32, h: 32}}
    );
    
    const cafeMarker = new H.map.Marker({
        lat: cafe.position.lat, 
        lng: cafe.position.lng
    }, {icon: cafeIcon});
    
    map.addObject(cafeMarker);
    
    cafeMarker.addEventListener('tap', function() {
        showCafeDetails(map, cafe, apiKey);
    });
}

// Kafe detaylarını göster (fotoğraflı ve daha sağlam)
async function showCafeDetails(map, cafe, apiKey) {
    // Önceki tüm InfoBubble'ları temizle
    ui.getBubbles().forEach(bubble => ui.removeBubble(bubble));

    // 'browse' sonucundan gelen temel bilgilerle ilk içeriği oluştur
    let initialContent = `<div style="width: 250px; font-family: Arial, sans-serif;">
                     <h3 style="margin: 0 0 10px 0; color: #8B4513;">${cafe.title || 'İsimsiz Mekan'}</h3>
                     <p style="margin: 5px 0;">${cafe.address ? cafe.address.label : 'Adres bilgisi yok'}</p>
                     <div id="photo-container-${cafe.id}" style="text-align: center; padding: 10px 0; font-style: italic;">Fotoğraf yükleniyor...</div>
                   </div>`;

    const bubble = new H.ui.InfoBubble(
        { lat: cafe.position.lat, lng: cafe.position.lng },
        { content: initialContent }
    );
    ui.addBubble(bubble);

    try {
        const response = await fetch(`https://lookup.search.hereapi.com/v1/lookup?id=${cafe.id}&apiKey=${apiKey}`);
        if (!response.ok) {
            throw new Error(`API isteği başarısız: ${response.status}`);
        }
        const data = await response.json();

        // 'lookup' yanıtından gelen detaylı bilgilerle içeriği zenginleştir
        let photoHtml = '<div style="text-align: center; padding: 10px 0; font-style: italic;">Fotoğraf bulunamadı.</div>';
        if (data.media && data.media.images && data.media.images.items && data.media.images.items.length > 0) {
            const imageItem = data.media.images.items[0];
            const photoUrl = (imageItem.variants && imageItem.variants.length > 0) ? imageItem.variants[0].src : imageItem.src;
            if (photoUrl) {
                photoHtml = `<img src="${photoUrl}" style="width:100%; height:auto; border-radius:4px; margin-top:8px;">`;
            }
        }

        let fullContent = `<div style="width: 250px; font-family: Arial, sans-serif;">
                             <h3 style="margin: 0 0 10px 0; color: #8B4513;">${data.title || cafe.title}</h3>
                             ${photoHtml}`;

        fullContent += `<p style="margin: 5px 0;"><strong>Adres:</strong> ${data.address ? data.address.label : 'Adres bilgisi yok'}</p>`;

        if (data.categories && data.categories.length > 0) {
            fullContent += `<p style="margin: 5px 0;"><strong>Kategori:</strong> ${data.categories.map(c => c.name).join(', ')}</p>`;
        }

        if (cafe.distance) {
            const distanceKm = (cafe.distance / 1000).toFixed(2);
            fullContent += `<p style="margin: 5px 0;"><strong>Uzaklık:</strong> ${distanceKm} km</p>`;
        }
        
        if (data.contacts && data.contacts.phone && data.contacts.phone.length > 0) {
            fullContent += `<p style="margin: 5px 0;"><strong>Telefon:</strong> ${data.contacts.phone[0].value}</p>`;
        }
        if (data.contacts && data.contacts.www && data.contacts.www.length > 0) {
            fullContent += `<p style="margin: 5px 0;"><strong>Website:</strong> <a href="${data.contacts.www[0].value}" target="_blank">Siteyi Görüntüle</a></p>`;
        }

        if (data.openingHours && data.openingHours.length > 0 && data.openingHours[0].text) {
             fullContent += `<p style="margin: 5px 0;"><strong>Çalışma Saatleri:</strong><br>${data.openingHours[0].text.replace(/<br\/>/g, '<br>')}</p>`;
        }

        fullContent += `</div>`;
        
        bubble.setContent(fullContent);

    } catch (error) {
        console.error('Detaylar alınırken hata oluştu:', error);
        let errorContent = `<div style="width: 250px; font-family: Arial, sans-serif;">
                              <h3 style="margin: 0 0 10px 0; color: #8B4513;">${cafe.title}</h3>
                              <p style="margin: 5px 0;">${cafe.address ? cafe.address.label : ''}</p>
                              <div style="text-align: center; padding: 10px 0; font-style: italic; color: red;">Detaylar yüklenemedi.</div>
                            </div>`;
        bubble.setContent(errorContent);
    }
}


/**
 * Boilerplate map initialization code starts below:
 */

//Step 1: initialize communication with the platform
var apiKey = 'L6kLZYoeF1hkkv15x2JtfIihHLbKDf1aI7o0bwiBRDI';
var platform = new H.service.Platform({
    apikey: apiKey
});
var defaultLayers = platform.createDefaultLayers();

//Step 2: initialize a map
var map = new H.Map(document.getElementById('map'),
    defaultLayers.vector.normal.map, {
    center: {lat: 39.9334, lng: 32.8597}, // Ankara default
    zoom: 10,
    pixelRatio: window.devicePixelRatio || 1
});

window.addEventListener('resize', () => map.getViewPort().resize());

//Step 3: make the map interactive
var behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(map));

//Step 4: Create the default UI components
var ui = H.ui.UI.createDefault(map, defaultLayers);

// Step 5: main logic
getUserLocationAndShowCafes(map, platform, apiKey);

    </script>
</body>
</html>